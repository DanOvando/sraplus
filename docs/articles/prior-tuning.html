<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>prior-tuning • sraplus</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="prior-tuning">
<meta property="og:description" content="sraplus">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sraplus</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">3.7.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/sraplus.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/prior-tuning.html">prior-tuning</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/DanOvando/sraplus/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="prior-tuning_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>prior-tuning</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DanOvando/sraplus/blob/master/vignettes/prior-tuning.Rmd"><code>vignettes/prior-tuning.Rmd</code></a></small>
      <div class="hidden name"><code>prior-tuning.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="co">#&gt; ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.1 ──</span>
<span class="co">#&gt; ✓ ggplot2 3.3.5     ✓ purrr   0.3.4</span>
<span class="co">#&gt; ✓ tibble  3.1.5     ✓ dplyr   1.0.7</span>
<span class="co">#&gt; ✓ tidyr   1.1.4     ✓ stringr 1.4.0</span>
<span class="co">#&gt; ✓ readr   2.0.2     ✓ forcats 0.5.1</span>
<span class="co">#&gt; ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──</span>
<span class="co">#&gt; x dplyr::filter() masks stats::filter()</span>
<span class="co">#&gt; x dplyr::lag()    masks stats::lag()</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://danovando.github.io/sraplus/">sraplus</a></span><span class="op">)</span>

<span class="va">example_taxa</span> <span class="op">&lt;-</span> <span class="st">"gadus morhua"</span>

<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">cod</span><span class="op">)</span></code></pre></div>
<div id="tldr" class="section level1">
<h1 class="hasAnchor">
<a href="#tldr" class="anchor"></a>TL;DR</h1>
<p>I’ve added a tuning process to try and get the “post-model-pre-data” (or prior predictive) values of terminal depletion to match any “pre-model-pre-data” priors. I think it addresses some of Andre’s concerns, and from a practical perspective</p>
<ol style="list-style-type: decimal">
<li><p>Fixes the issue where really broad priors on terminal depletion from say the swept area ratio algorithm produced positively bias status estimates when run through sraplus (or indeed any standard stock reduciton algorithm, including catch-MSY)</p></li>
<li><p>Greatly improves stability of the model when actually fitting to data</p></li>
</ol>
<p>I’d like to get your feedback on the tuning steps, to make sure we’re all OK with it</p>
</div>
<div id="the-problem" class="section level1">
<h1 class="hasAnchor">
<a href="#the-problem" class="anchor"></a>the problem</h1>
<p>The sraplus package now includes a tuning routine to try and ensure that the “post-model-pre-data” prior matches the prior you put in. By “post-model-pre-data” here I mean basically filtering priors through a surplus production model with catches, but nothing you’re actually fitting to (no data).</p>
<p>The basic problem: consider a purely stock-reduction analysis case (with a Schaefer model for simplicity’s sake), where all you have are catches. In the absence of any prior on terminal depletion, any r/k combination that doesn’t crash the population works. So, any estimate of terminal depletion will be a function of your priors on r and k, and in particular as you allow k to be bigger, your post-data-pre-model “estimate” of terminal depletion will increase (0 = 0 * k, 1 = k).</p>
<p>Suppose you introduce a prior on terminal depletion? This creates two problem. First, by placing priors on r and k, given the catch, you are implicitly placing a prior on terminal depletion. So, by placing an explicit prior on terminal depletion, you’re placing a prior on a transformed parameter, and sort of “hiding” your implicit prior on terminal depletion which is a joint function of r, k, catch, and terminal depletion prior here.</p>
<p>Second, ideally, if we think we actually have a prior on terminal depletion, it shouldn’t change before and after seeing the catches (though see discussion on this later). But, in this example, if we pass all of those priors to a model, our “post-model-pre-data” prior on terminal depletion will be different (and always higher) than the prior we put in. This is because there are always more ways for a fishery to be less depleted than more depleted. So, this creates a behavior where it looks as though the model has “updated” it’s priors post SRA style process (e.g. Catch-MSY), even though it’s just a reflection of the sampling algorithm.</p>
<p>Simple example here using some cod data</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">driors</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_driors.html">format_driors</a></span><span class="op">(</span>
  taxa <span class="op">=</span> <span class="va">example_taxa</span>,
  catch <span class="op">=</span> <span class="va">cod</span><span class="op">$</span><span class="va">catch</span>,
  years <span class="op">=</span> <span class="va">cod</span><span class="op">$</span><span class="va">year</span>,
  terminal_state <span class="op">=</span> <span class="fl">0.25</span>,
  terminal_state_cv <span class="op">=</span> <span class="fl">0.25</span>,
  growth_rate_prior_cv <span class="op">=</span> <span class="fl">0.5</span>
<span class="op">)</span>

<span class="fu"><a href="../reference/plot_driors.html">plot_driors</a></span><span class="op">(</span><span class="va">driors</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="prior-tuning_files/figure-html/driors-1.png" alt="Sample catches and priors" width="700"><p class="caption">
Sample catches and priors
</p>
</div>
<p>Focus on the panel for the prior and “posterior” (I know, I know, no data, but not about to change the legend depending on whether there are data to fit to or not) for <code>terminal_state</code> (Fig.@ref(fig:untuned-fit)). We’d like them to match, but our post-model-pre-data estimate of terminal_state is now higher than our “prior”.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"> <span class="va">untuned_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_sraplus.html">fit_sraplus</a></span><span class="op">(</span>driors <span class="op">=</span> <span class="va">driors</span>,
                       engine <span class="op">=</span> <span class="st">"sir"</span>,
                       draws <span class="op">=</span> <span class="fl">1e6</span>,
                       estimate_proc_error <span class="op">=</span> <span class="cn">TRUE</span>, 
                       tune_prior_predictive <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="fu"><a href="../reference/plot_prior_posterior.html">plot_prior_posterior</a></span><span class="op">(</span><span class="va">untuned_fit</span>, <span class="va">driors</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="prior-tuning_files/figure-html/untuned-fit-1.png" alt="Prior-posterior plots for SIR algorithm without tuning process. Note that the 'posterior' on terminal depletion does not match the prior, despite having no data in the model to update our priors" width="700"><p class="caption">
Prior-posterior plots for SIR algorithm without tuning process. Note that the ‘posterior’ on terminal depletion does not match the prior, despite having no data in the model to update our priors
</p>
</div>
</div>
<div id="the-solution-i-hope" class="section level1">
<h1 class="hasAnchor">
<a href="#the-solution-i-hope" class="anchor"></a>The Solution (I Hope)</h1>
<p>Andre recommended solving this by estimating r and terminal depletion instead of r and k. However, this creates a bit of a computational bottleneck, and some issues of its own I’ll touch on later.</p>
<p>I’ve come up with a somewhat hacky approximation to this problem. By setting <code>tune_prior_predictive = TRUE</code>, the algorithm now does a version of the following</p>
<ol style="list-style-type: decimal">
<li><p>Run a normal SRA style algorithm (sample from priors on r and k, filter through catches)</p></li>
<li><p>Assign a prior probability to each SRA draw based on the prior on terminal depletion</p></li>
<li><p>Create high-resolution bins of terminal depletion, and calculate the mean prior probability in each bin</p></li>
<li><p>Assign each draw from the SRA algorithm to a terminal depletion bin (and associated mean prior probability)</p></li>
<li><p>Assign a sampling weight to each draw within a bin equal to <span class="math inline">\(\frac{BinPriorProbability}{NumberInBin}\)</span></p></li>
<li><p>Now run the SIR algorithm, sampling from the draws with replacement and weighting by the weights calculated in step 5.</p></li>
</ol>
<p>The end result is that more or less the post-model-pre-data prior on terminal depletion should match the prior on terminal depletion supplied. Basically what this is doing is saying, given the production model and catches, what r and k priors produce your prior on terminal depletion. It’s not a perfect match, but it’s a lot closer than when you don’t apply the tuning step (Fig.@ref(fig:tuned-fit)).</p>
<p>When <code>tune_prior_predictive = FALSE</code>, step 5 is turned off, and each draw from the SRA algorithm is sampled in proportion to its prior probability. The problem here, is that suppose that your prior probability assigns a very small probability to a depletion of 0.99 (again meaning 0.99 * k, s basically unfished). However, if you have a wide enough prior on K, even through the prior probability of any one draw that produces a depletion of 0.99 will be small, there will be tons of them, since any k between the smallest k that produces a depletion of 0.99 up until k = Infinity will have the same prior probability. So, as a result you end up with a lot more high k values, and subsequently an upward shift in your post-model-pre-data prior on terminal depletion.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R">
 <span class="va">tuned_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_sraplus.html">fit_sraplus</a></span><span class="op">(</span>driors <span class="op">=</span> <span class="va">driors</span>,
                       engine <span class="op">=</span> <span class="st">"sir"</span>,
                       draws <span class="op">=</span> <span class="fl">1e6</span>,
                       estimate_proc_error <span class="op">=</span> <span class="cn">TRUE</span>, 
                       tune_prior_predictive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu"><a href="../reference/plot_prior_posterior.html">plot_prior_posterior</a></span><span class="op">(</span><span class="va">tuned_fit</span>, <span class="va">driors</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="prior-tuning_files/figure-html/tuned-fit-1.png" alt="Prior-posterior plots for SIR algorithm with tuning process. Note that the 'posterior' on terminal depletion now more or less matches the prior, as we should hope since we have no data to update said prior" width="700"><p class="caption">
Prior-posterior plots for SIR algorithm with tuning process. Note that the ‘posterior’ on terminal depletion now more or less matches the prior, as we should hope since we have no data to update said prior
</p>
</div>
<p>The upshot to all this is that now, when running in SIR mode, and with a prior on say terminal depletion informed by swept area ratio, even if the prior is very diffuse, the terminal depletion post SIR model will more or less match the swept area ratio based prior.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_sraplus.html">plot_sraplus</a></span><span class="op">(</span>`With Tuning` <span class="op">=</span> <span class="va">tuned_fit</span>, `Without Tuning` <span class="op">=</span> <span class="va">untuned_fit</span><span class="op">)</span></code></pre></div>
<p><img src="prior-tuning_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>When we actually have say an index to fit to, when <code>tune_prior_predictive = TRUE</code>, sraplus first uses the sir process above to re-tune any priors on r and k. From a practical perspective, if the index is informative, the only effect of this is to dramatically stabilize the model, since it spends a lot less time in r-k regions that crash the population.</p>
</div>
<div id="what-do-catches-tell-us" class="section level1">
<h1 class="hasAnchor">
<a href="#what-do-catches-tell-us" class="anchor"></a>What do Catches Tell Us?</h1>
<p>The goal of all of this is twofold: first, to try and resolve Andre’s Borel’s Paradox concerns when placing priors on r, k and terminal depletion, and his issues with the catch not being data. The second and more practical upshot is to improve model stability by having it spend less time in parameter spaces that crash the population.</p>
<p>However, I’m having some trouble with Andre’s position that the catches are not data and our priors shouldn’t be updated by them. The crux of the issue is that catches, at least to my mind, do contain some information as they approach zero. Suppose that we are asked for our default prior for terminal depletion of a fishery, and we are a pessimistic person about the state of fisheries, so I say terminal_depletion ~ log_normal(log(0.2), .25).</p>
<p>Now, suppose you show me the catch history for a fishery (assuming complete time series and perfectly accurate), and it is zero every year. Shouldn’t I update my priors? Since if we assume a surplus production model, there’s no realistic way for consistently zero catches to produce our pessimistic prior on terminal depletion. This issue raises its head sometimes when catches were high in the past, but have been consistently extremely low for a long time: there’s not way for such a catch series to produce very low depletion values without extremely low r values, or a very long string of very bad process errors, which at some point should clash with our priors on r and process error. Not a problem to solve in this paper in my opinion, but putting it here for discussion.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Dan Ovando.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
